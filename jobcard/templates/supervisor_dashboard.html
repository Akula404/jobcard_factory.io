{% load custom_filters %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Supervisor Dashboard</title>

<style>
body{
    font-family:'Segoe UI',system-ui,sans-serif;
    margin:0;
    background:linear-gradient(135deg,#e0f2fe,#dbeafe);
    color:#1f2937;
}

.top-bar{
    display:flex;
    justify-content:flex-end;
    align-items:center;
    gap:20px;
    padding:20px 40px 0;
}

.top-bar select{
    padding:10px 14px;
    font-size:15px;
    border-radius:12px;
    border:1px solid #94a3b8;
    cursor:pointer;
    background:white;
    font-weight:600;
    transition:.2s;
}
.top-bar select:hover{
    border-color:#3b82f6;
    box-shadow:0 4px 12px rgba(59,130,246,0.2);
}

.shift-reset-btn{
    display:flex;
    align-items:center;
    gap:10px;
    background:linear-gradient(135deg,#ff416c,#ff4b2b);
    color:white;
    border:none;
    padding:14px 24px;
    font-size:15px;
    font-weight:700;
    border-radius:14px;
    cursor:pointer;
    box-shadow:0 10px 25px rgba(0,0,0,0.15);
    transition:.25s;
}
.shift-reset-btn:hover{
    transform:translateY(-2px);
    box-shadow:0 16px 35px rgba(0,0,0,0.25);
}

.page-title{
    text-align:center;
    padding:25px;
    margin:0 0 25px;
    font-size:32px;
    font-weight:700;
    background:linear-gradient(90deg,#1e3c72,#2a5298);
    color:white;
    border-radius:0 0 20px 20px;
    letter-spacing:1px;
}

.line-card{
    background:#fff;
    border-radius:20px;
    padding:30px;
    margin:25px auto;
    width:95%;
    box-shadow:0 12px 28px rgba(0,0,0,0.08);
    transition:.3s;
}
.line-card:hover{
    transform:translateY(-3px);
    box-shadow:0 18px 38px rgba(0,0,0,0.15);
}

.line-title{
    margin:0 0 20px;
    font-size:26px;
    font-weight:700;
    background:linear-gradient(90deg,#4facfe,#00f2fe);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
}

.wrapper{
    overflow-x:auto;
}
table{
    width:100%;
    border-collapse:collapse;
    font-size:14px;
}
th,td{
    padding:12px 8px;
    text-align:center;
}
th{
    background:#1e293b;
    color:white;
    letter-spacing:1px;
    font-weight:600;
}
.label{
    text-align:left;
    font-weight:600;
}
.total-value{
    font-weight:800;
    color:#0ea5e9;
}

.live-dot{
    width:10px;
    height:10px;
    border-radius:50%;
    background:#10b981;
    display:inline-block;
    margin-right:6px;
    animation:pulse 1s infinite;
}
@keyframes pulse{
0%{transform:scale(1)}
50%{transform:scale(1.3)}
100%{transform:scale(1)}
}

@media(max-width:768px){
    .top-bar{
        flex-direction:column;
        align-items:flex-start;
    }
    .line-card{
        width:100%;
        padding:20px;
    }
}
</style>
</head>
<body>

<div class="top-bar">

<form method="get">
<label style="font-weight:700;"><b>View Shift:</b></label>
<select name="shift" onchange="this.form.submit()" style="font-weight:600;">
<option value="Day" {% if shift == "Day" %}selected{% endif %}><b>Day</b></option>
<option value="Night" {% if shift == "Night" %}selected{% endif %}><b>Night</b></option>
</select>
</form>

<form id="resetForm" method="post" action="{% url 'jobcard:reset_shift' %}" onsubmit="return confirmResetShift();">
    {% csrf_token %}
    <input type="hidden" name="shift" value="{{ shift }}">
    <button type="submit" class="shift-reset-btn" style="font-weight:700;">⟳ Start {{ shift }} Shift</button>
</form>

<script>
function confirmResetShift(){
    const shift = "{{ shift }}";
    return confirm(`⚠️ Warning: You are about to start the ${shift} shift.\nAll current operator entries for this shift will be deleted and reset to zero.\nDo you want to continue?`);
}
</script>

</div>

<h2 class="page-title">Supervisor Dashboard — {{ today }}</h2>

<div id="dashboard-container">

{% for key,data in dashboard_data.items %}
<div class="line-card">

<h3 class="line-title">{{ key|cut:"_Day"|cut:"_Night"|title }}</h3>

<div class="wrapper">
<div class="wrapper">
<table>
<tr>
<th>Hourly Updates</th>
{% for i in hour_range %}
<th>H{{i}}</th>
{% endfor %}
<th>Total</th>
</tr>

<tr>
<td class="label"><span class="live-dot"></span>Live Output</td>

{% for val in data.hour_totals %}
<td class="hour-cell"
    data-key="{{ key }}"
    data-hour="{{ forloop.counter }}">
    {{ val }}
</td>
{% endfor %}

<td class="total-value"
    data-total="{{ key }}">
    {{ data.total }}
</td>
</tr>

</table>
</div>
</div>
</div>
{% endfor %}

</div>

<script>
let refreshPaused = false;
let idleTimer = null;
let isFetching = false; // prevent overlapping requests

function pauseRefresh() {
    refreshPaused = true;
    if (idleTimer) clearTimeout(idleTimer);
    idleTimer = setTimeout(() => refreshPaused = false, 15000); // resume after 15s idle
}

// pause refresh on user activity
["focusin", "click", "keydown", "mousemove"].forEach(e => {
    document.addEventListener(e, pauseRefresh);
});

function fetchDashboard() {
    if (refreshPaused || isFetching) return; // skip if paused or previous request ongoing
    isFetching = true;

    const shift = "{{ shift }}"; // Django template variable

    fetch(`/jobcard/supervisor-dashboard/?ajax=1&shift=${shift}`)
        .then(r => r.json())
        .then(data => {

            /* -------- LOCK HOURS -------- */
            if (data.global_locked_hours) {
                document.querySelectorAll(".hour-cell").forEach(cell => {
                    const h = parseInt(cell.dataset.hour);
                    if (data.global_locked_hours.includes(h)) {
                        cell.classList.add("locked");
                    } else {
                        cell.classList.remove("locked");
                    }
                });
            }

            /* -------- UPDATE TOTALS -------- */
            if (data.dashboard_data) {
                Object.entries(data.dashboard_data).forEach(([key, val]) => {

                    val.hour_totals.forEach((num, i) => {
                        const el = document.querySelector(
                            `[data-key="${key}"][data-hour="${i + 1}"]`
                        );
                        if (el) el.textContent = num;
                    });

                    const total = document.querySelector(`[data-total="${key}"]`);
                    if (total) total.textContent = val.total;
                });
            }

        })
        .catch(err => console.error("Dashboard fetch error:", err))
        .finally(() => isFetching = false); // reset fetch lock
}

// Poll every 5 seconds instead of 2
setInterval(fetchDashboard, 3000);
</script>

</body>
</html>