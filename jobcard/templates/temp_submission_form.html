<h2 class="title">Operator Live Entry â€” Shift {{ shift }}</h2>

{% for line, form, obj in forms_data %}
<div class="line-card">
  <div class="line-title">{{ line|title }}</div>
  <form class="line-form" data-line="{{ line }}">
    {% csrf_token %}
    <input type="hidden" name="line" value="{{ line }}">

    <div class="grid">
      {{ form.hour1 }} {{ form.hour2 }} {{ form.hour3 }}
      {{ form.hour4 }} {{ form.hour5 }} {{ form.hour6 }}
      {{ form.hour7 }} {{ form.hour8 }} {{ form.hour9 }}
      {{ form.hour10 }} {{ form.hour11 }}
    </div>

    <div class="total-box">
      <div class="status-wrap">
        <span class="status"></span> Live updating
      </div>
      <div>Total: <span class="total-value total">0</span></div>
    </div>
  </form>
</div>
{% endfor %}

<script>
document.querySelectorAll(".line-form").forEach(form => {
  const inputs = form.querySelectorAll("input[type=number]");
  const totalEl = form.querySelector(".total");
  const line = form.dataset.line;

  function calc() {
    let t = 0;
    inputs.forEach(i => { if(i.value) t += parseInt(i.value) || 0; });
    totalEl.textContent = t;
  }

  inputs.forEach(i => {
    i.addEventListener("input", () => {
      calc();

      // AJAX send only this form
      const fd = new FormData(form);
      fetch("?shift={{shift}}", {
        method: "POST",
        headers: {
          "X-CSRFToken": form.querySelector("[name=csrfmiddlewaretoken]").value,
          "X-Requested-With": "XMLHttpRequest"
        },
        body: fd
      });
    });
  });

  calc();
});
</script>
